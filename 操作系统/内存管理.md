### 虚拟内存

虚拟内存是为了更加有效地管理内存所出现的一种策略，它使得应用程序认为它拥有一块连续可用的内存 (一个连续完整的地址空间)。但虚拟内存通常是被分隔成多个物理内存碎片，还有一部分暂时存储在磁盘上，在需要时才会加载到物理内存中来。

在用户进程和物理内存之间引入虚拟内存主要有以下的优点：

* 进程隔离：不同进程的虚拟地址之间没有关系，所以一个进程的操作不会对其它进程造成影响。
* 进程无法直接分配和回收物理内存，这些工作全部由操作系统完成，可以保证系统的安全。
* 提高内存利用率，物理内存延时分配，只有真正使用时才将它从磁盘上加载到内存中来，在内存不足时又可以将这部分内存清空掉。
* 提供更大的地址空间，并且地址空间是连续的，使得程序编写、链接更加简单。

> 如果直接把物理地址暴露出来的话会带来严重问题，可能对操作系统造成伤害以及给同时运行多个程序造成困难。
>
> * 用户程序可以访问任意内存，寻址内存的每个字节，这样就很容易（有意或者无意）破坏操作系统，造成操作系统崩溃。
>
> * 想要同时运行多个程序特别困难，比如你想同时运行一个微信和一个 QQ 音乐都不行。为什么呢？举个简单的例子：微信在运行的时候给内存地址 1xxx 赋值后，QQ 音乐也同样给内存地址 1xxx 赋值，那么 QQ 音乐对内存的赋值就会覆盖微信之前所赋的值，这就造成了微信这个程序就会崩溃。

### 分页

页式内存管理就是将程序的逻辑地址空间划分为固定大小的页 (4 KB)，而物理内存划分为**同样大小**的页框。每个用户进程维护了一个单独的页表，通过这个页表实现虚拟内存到物理内存地址空间的映射。

在分页机制下，虚拟地址分为两部分，高位部分是页号，低位部分是页内偏移量。根据页号可以在页表中找到页框号，也就是物理内存的基地址，然后用这个基地址替换掉虚拟地址的页号得到物理地址。

#### 内存申请过程

用户进程向操作系统发出内存申请请求，系统会给进程分配一个虚拟地址。当 CPU 根据虚拟地址去查询相应的物理地址时，会发现页表项的有效位为 0，这样就产生一个缺页中断。操作系统会进入系统内核空间分配物理内存、更新进程页表，最后再返回用户空间，恢复进程的运行。

> 页表的每一个表项分两部分，第一部分是有效位，记录此页表项对应的虚拟地址是否在内存中，第二部分记录物理内存页的地址。

#### 页面置换算法

当发生缺页中断时，如果操作系统内存中没有空闲页面，则操作系统必须在内存选择一个页面将其移出内存，以便为即将调入的页面让出空间。而用来选择淘汰哪一页的规则叫做页面置换算法。 

* FIFO (First In First Out)：在操作系统中经常被用到，比如作业调度 (主要实现简单，很容易想到)。
* LRU (Least recently use)：最近最少使用算法，根据使用时间到现在的长短来判断。
* LFU (Least frequently use)：最少使用次数算法，根据使用次数来判断；
* OPT (Optimal replacement)：最优置换算法，就是要保证置换出去的是不再被使用的页，或者是在实际内存中最晚使用的算法。

#### 颠簸 (抖动)

颠簸本质上是指频繁的页面置换行为，所有的页都在使用，它置换了一个页，但又立刻再次需要这个页。因此，会不断产生缺页中断，导致整个系统的效率急剧下降，这种现象称为颠簸（抖动）。

内存颠簸的解决策略包括：

* 修改页面替换算法
* 增大物理内存。

#### 分页内存管理面临的问题

* 虚拟地址到物理地址的转换要快。

* 如果虚拟地址空间特别大，页表也会很大。

##### 快表

快表类似于一个缓存，与 Redis 作用相似。

用户访问地址空间时首先根据虚拟地址中的页号查快表，如果该页在快表中，直接从快表中读取相应的物理地址；如果该页不在快表中，就访问内存中的页表，再从页表中得到物理地址，同时将页表中的映射表项添加到快表中；当快表填满又要登记新页时，就按照一定的淘汰策略淘汰掉快表中的一个页。

##### 多级页表

多级页表由多个层次的页表组成。前面的页表存储的都是索引指针信息，最后一级页表存储的是实际的信息。只有用到这一页的信息时才将它加入多级页表中，这样可以避免将全部页表一直保存在内存中。

### 分段

段式管理把物理内存分为一段段的。每个段定义了一组逻辑信息，例如代码段、数据段等等。通过段表实现逻辑地址到物理地址映射。一共有如下 3 中类型的段表：

* 进程段表：描述组成进程地址空间的各段，可以是指向系统段表中表项的索引。每段有段基址，即段内地址。

* 系统段表：系统所有占用段（已经分配的段）。

* 空闲段表：内存中所有空闲段，可以结合到系统段表中。

#### 分段与分页的共同点和区别

##### 共同点

* 分页机制和分段机制都是为了提高内存利用率，减少内存碎片。
* 页和段都是离散存储的，所以两者都是离散分配内存的方式。但是，每个页和段中的内存是连续的。

##### 区别

* 页的大小是固定的，由操作系统决定；而段的大小不固定，由当前运行的程序决定。
* 分页仅仅是为了满足操作系统内存管理的需求，而段是逻辑信息的单位，能够更好满足用户的需要。

### 段页式

段页式管理机制就是把主存先分成若干段，每个段又分成若干页，也就是说段页式管理机制中段与段之间以及段的内部的都是离散的。
