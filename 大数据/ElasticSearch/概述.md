### 概述

Elasticsearch 是一个开源的高扩展的分布式全文检索引擎，它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理 PB 级别的数据。 优势如下：

1. 分布式实时文件存储，可将每一个字段存入索引，使其可以被检索到。

2. 实时分析的分布式搜索引擎。负载再平衡和路由在大多数情况下自动完成。

   > 分布式：索引分拆成多个分片，每个分片可有零个或多个副本。集群中的每个数据节点都可承载一个或多个分片，并且协调和处理各种操作。

3. 可以扩展到上百台服务器，处理 PB 级别的结构化或非结构化数据。

4. 支持插件机制，分词插件、同步插件、Hadoop 插件、可视化插件等。

### 核心概念

#### Cluster：集群

Elasticsearch 集群由一个或多个节点组成，可通过其集群名称进行标识。可以在 config/elasticsearch.yml 里定制集群名字。

#### Node：节点

单个 Elasticsearch 实例。一个集群由一个或多个 Node 组成。

根据 Node 的作用，可以分为如下的几种：

##### master-eligible

可以作为主 Node。一旦成为主 Node，它可以管理整个 cluster 的设置及变化：

* 创建，更新，删除 index。
* 添加或删除 Node。
* 为 Node 分配 shard。

Master 选举过程：

* 对所有可以成为 master 的节点根据 id 字典排序，每次选举每个节点都把自己所知道节点排一次序，然后选出 id 最小的那个节点，暂且认为它是 master 节点。

* 如果对某个节点的投票数超过半数且该节点自己也选举自己，那这个节点就是 master。否则重新选举一直到满足上述条件。

##### data

数据 Node，存储数据

##### ingest

数据接入 (比如 pipepline)

##### machine learning

> 可以在命令行或者 Elasticsearch 的配置文件（Elasticsearch.yml）来定义 Node 类型，如果没有任何配置，那么我们可以认为这个 Node 是作为一个 Coordinating Node。在这种情况下，它可以接受外部的请求，并转发到相应的节点来处理。
>
> ```shell
> Node.master:true
> Node.data:false
> Node.ingest:false
> Node.ml:false
> ```

#### Index：索引

在 Elasticsearch 中，索引是文档的集合。每个 Index 由一个或多个 documents 组成，并且这些 document 可以分布于不同的 shard 之中。

每当一个文档进来后，根据文档的 id 会自动进行 hash 计算，将文档均衡的存储到所有的 shard 中。

#### Type：类型

类型是文档的逻辑容器，类似于表。

#### Document：文档

Elasticsearch 是面向文档的，文档是索引或搜索的最小数据单元。

#### Shard：分片。

一个索引可以拆分成多个分片，每个分片可以放到不同的服务器上。这样做的好处有：

* 允许水平扩展。
* 提高性能和吞吐量。

当你查询的索引分布在多个分片上时，ES 会把查询发送给每个相关的分片，并将结果组合在一起，而应用程序并不知道分片的存在。即这个过程对用户来说是透明的。

##### Primary shard

每个文档都存储在一个 Primary shard。 索引文档时，它首先在 Primary shard 上编制索引，然后在此分片的所有副本上 (replica) 编制索引。Index 可以包含一个或多个主分片。

**但创建索引后，无法更改索引中的主分片数**。因为 ElasticSearch 会依据每个 document 的 id 及 shard 的数量来把相应的 document 分配到相应的 shard 中。如果这个数量以后修改的话，那么每次搜索的时候，可能会找不到相应的 shard。

##### Replica shard

每个主分片可以具有零个或多个副本。这样做的好处是：

* 提高性能：get 和 search 请求可以由主 shard 或副本 shard 处理。
* 提高可靠性：数据的冗余备份。
* 提高可用性：如果主分片故障，可以将副本分片提升为主分片。

默认情况下，每个主分片都有一个副本，但可以在现有索引上动态更改副本数。 永远不会在与其主分片相同的节点上启动副本分片。

##### Shard 健康状态

* 红色：集群中至少有一个主分片未分配。
* 黄色：已分配所有主分片，但至少有一个副本未分配。
* 绿色：分配完成所有分片。
